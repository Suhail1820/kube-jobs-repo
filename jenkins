pipeline {
    agent any

    environment {
        // Set KUBECONFIG to /home/admin/.kube/config
        KUBECONFIG = '/home/admin/.kube/config'
    }

    stages {
        stage('Checkout SCM') {
            steps {
                checkout scm
            }
        }

        stage('Deploy Job to Kubernetes') {
            steps {
                withCredentials([file(credentialsId: 'kube-conf', variable: 'KUBECONFIG_FILE')]) {
                    script {
                        // Copy the kubeconfig file from Jenkins credentials to the desired path
                        sh 'mkdir -p /home/admin/.kube && cp $KUBECONFIG_FILE $KUBECONFIG'

                        // Use kubectl with the provided kubeconfig file
                        sh '''
                            kubectl config use-context jenkins-context
                            kubectl apply -f /home/admin/job.yaml
                        '''
                    }
                }
            }
        }
    }
}
