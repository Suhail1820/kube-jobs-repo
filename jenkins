pipeline {
    agent any
    triggers {
        pollSCM('* * * * *') // Poll the repository every minute for changes
    }
    stages {
        stage('Checkout Code') {
            steps {
                checkout scm: [
                    $class: 'GitSCM',
                    branches: [[name: 'refs/heads/main']],  // Branch is correctly set to 'main'
                    userRemoteConfigs: [[url: 'https://github.com/Suhail1820/kube-jobs-repo.git']]
                ]
            }
        }
        stage('Deploy to Kubernetes') {
            steps {
                script {
                    withCredentials([string(credentialsId: 'jenkins-sec', variable: 'KUBE_TOKEN')]) {
                        sh """
                            # Set the Kubernetes credentials and context
                            kubectl config set-credentials jenkins --token=${KUBE_TOKEN}
                            kubectl config set-context jenkins-context --user=jenkins --cluster=minikube
                            kubectl config use-context jenkins-context
                            
                            # Fetch and apply the job.yaml from GitHub
                            kubectl apply -f /manifests/job.yaml
                        """
                    }
                }
            }
        }
    }
    post {
        success {
            echo "Deployment successful!"
        }
        failure {
            echo "Deployment failed!"
        }
    }
}
